<script>
    // --- 1. UI LOGIC (DARK MODE & SIDEBAR) ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const darkIcon = document.getElementById('theme-toggle-dark-icon');
    const lightIcon = document.getElementById('theme-toggle-light-icon');

    function syncTheme() {
        if (document.documentElement.classList.contains('dark')) {
            darkIcon.classList.add('hidden');
            lightIcon.classList.remove('hidden');
        } else {
            lightIcon.classList.add('hidden');
            darkIcon.classList.remove('hidden');
        }
    }
    syncTheme();

    themeToggleBtn.addEventListener('click', function() {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        syncTheme();
    });

    function toggleSubMenu(id) {
        const menu = document.getElementById(id);
        const arrow = document.getElementById('arrow-' + id);
        if(menu) menu.classList.toggle('hidden');
        if(arrow) arrow.classList.toggle('rotate-90');
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('-translate-x-full');
        document.getElementById('sidebar-overlay').classList.toggle('hidden');
    }

    // --- 2. TRAFFIC FORMATTER ---
    function formatBitrate(bps) {
        let bits = bps * 8; 
        if (bits <= 0 || isNaN(bits)) return '0 bps';
        const k = 1000;
        const sizes = ['bps', 'Kbps', 'Mbps', 'Gbps'];
        const i = Math.floor(Math.log(bits) / Math.log(k));
        const val = bits / Math.pow(k, i);
        return (i === 0 ? val.toFixed(0) : val.toFixed(1)) + ' ' + sizes[i];
    }

    // --- 3. REAL-TIME DATA SYNC ---
    async function fetchRealtimeData() {
        const path = window.location.pathname;
        const parts = path.split('/');
        
        // Ambil ID Router (Asumsi URL: /dashboard/ID atau /dashboard/ID/interfaces)
        const routerId = parts[2]; 
        if (!routerId) return;

        try {
            const response = await fetch(`/api/router/${routerId}/stats`);
            const data = await response.json();

            if (data.error) return;

            // A. Update Info System (Hanya jika elemennya ada/Halaman Dashboard)
            const cpuText = document.getElementById('cpu-text');
            if (cpuText) {
                cpuText.innerHTML = `${data.cpu}<span class="text-sm font-normal text-slate-400">%</span>`;
                document.getElementById('cpu-bar').style.width = `${data.cpu}%`;
                document.getElementById('ram-text').innerHTML = `${data.freeRam}<span class="text-sm font-normal text-slate-400 ml-1">MB</span>`;
                document.getElementById('uptime-text').innerText = data.uptime;
            }

            // B. Update Traffic Interfaces (Berjalan di Dashboard & Halaman Interfaces)
            if (data.interfaces) {
                data.interfaces.forEach((iface, index) => {
                    const rxCell = document.getElementById(`rx-${index}`);
                    const txCell = document.getElementById(`tx-${index}`);
                    
                    if (rxCell) rxCell.innerHTML = (path.includes('interfaces') ? `<i class="fas fa-caret-down mr-1"></i>` : '') + formatBitrate(iface.rx);
                    if (txCell) txCell.innerHTML = (path.includes('interfaces') ? `<i class="fas fa-caret-up mr-1"></i>` : '') + formatBitrate(iface.tx);

                    // Update Status Badge (Hanya di halaman interfaces)
                    const statusBadge = document.getElementById(`status-${index}`);
                    if (statusBadge && path.includes('interfaces')) {
                        // Logika warna status bisa ditambahkan di sini jika perlu real-time
                    }
                });
            }
        } catch (error) {
            console.error("Monitoring Error:", error);
        }
    }

    // Jalankan setiap 2 detik
    setInterval(fetchRealtimeData, 2000);
    // Jalankan sekali saat load
    window.onload = fetchRealtimeData;
</script>
</body>
</html>