<script>
    // --- 1. DARK MODE & UI LOGIC ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const darkIcon = document.getElementById('theme-toggle-dark-icon');
    const lightIcon = document.getElementById('theme-toggle-light-icon');

    function syncTheme() {
        if (document.documentElement.classList.contains('dark')) {
            darkIcon.classList.add('hidden');
            lightIcon.classList.remove('hidden');
        } else {
            lightIcon.classList.add('hidden');
            darkIcon.classList.remove('hidden');
        }
    }

    syncTheme();

    themeToggleBtn.addEventListener('click', function() {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        syncTheme();
    });

    function toggleSubMenu(id) {
        const menu = document.getElementById(id);
        const arrow = document.getElementById('arrow-' + id);
        menu.classList.toggle('hidden');
        if(arrow) arrow.classList.toggle('rotate-90');
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('-translate-x-full');
        document.getElementById('sidebar-overlay').classList.toggle('hidden');
    }

    // --- 2. ACCURATE TRAFFIC FORMATTER (Kbps/Mbps) ---
function formatBitrate(bps) {
    // bps di sini adalah Bytes Per Second dari backend
    // Kalikan 8 untuk mendapatkan bits per second
    let bits = bps * 8;
    
    if (bits < 1) return '0 bps';

    const k = 1000; 
    const sizes = ['bps', 'Kbps', 'Mbps', 'Gbps'];
    
    // Jika di bawah 1000 bps, langsung tampilkan bps
    if (bits < k) return bits.toFixed(0) + ' bps';

    // Cari index satuan
    const i = Math.floor(Math.log(bits) / Math.log(k));
    const val = bits / Math.pow(k, i);

    // Tampilkan 1 desimal untuk Kbps ke atas agar pergerakannya halus
    return val.toFixed(1) + ' ' + sizes[i];
}

    // --- 3. REAL-TIME DATA SYNC ---
    async function fetchStats() {
        const parts = window.location.pathname.split('/');
        const routerId = parts[parts.length - 1];

        // Jalankan hanya jika di URL dashboard
        if (!window.location.pathname.includes('/dashboard/') || window.location.pathname.includes('/interfaces')) return;

        try {
            const response = await fetch(`/api/router/${routerId}/stats`);
            const data = await response.json();

            if (data.cpu !== undefined) {
                // Update System Metrics
                document.getElementById('cpu-text').innerHTML = `${data.cpu}<span class="text-sm font-normal text-slate-400">%</span>`;
                document.getElementById('cpu-bar').style.width = `${data.cpu}%`;
                document.getElementById('ram-text').innerHTML = `${data.freeRam}<span class="text-sm font-normal text-slate-400 ml-1">MB</span>`;
                document.getElementById('uptime-text').innerText = data.uptime;

                // Update Interface Traffic (TX/RX)
                if (data.interfaces) {
                    data.interfaces.forEach((iface, index) => {
                        const rxCell = document.getElementById(`rx-${index}`);
                        const txCell = document.getElementById(`tx-${index}`);
                        const statusBadge = document.getElementById(`status-${index}`);

                        if (rxCell) rxCell.innerText = formatBitrate(iface.rx);
                        if (txCell) txCell.innerText = formatBitrate(iface.tx);

                        if (statusBadge) {
                            if (iface.running === 'true') {
                                statusBadge.className = "px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-tighter bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400";
                                statusBadge.innerText = "Active";
                            } else {
                                statusBadge.className = "px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-tighter bg-slate-100 text-slate-500 dark:bg-slate-700";
                                statusBadge.innerText = "Idle";
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.warn("Real-time sync paused: Server or Router unreachable.");
        }
    }

    // Interval Update: 2 Detik
    setInterval(fetchStats, 1000);
</script>
</body>
</html>